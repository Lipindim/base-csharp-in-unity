using System;
using System.Collections.Generic;
using System.Linq;


namespace Labyrinth
{

    public class InvulnerabilityBostController : IUpdatable
    {

        #region Fields

        private PlayerModel _playerModel;

        private float _effectDuration;

        #endregion


        #region ClassLifeCycles

        public InvulnerabilityBostController(IEnumerable<InteractiveObject> interactiveObjects, PlayerModel playerModel)
        {
            if (interactiveObjects == null)
                throw new ArgumentNullException(nameof(interactiveObjects));
            if (playerModel == null)
                throw new ArgumentNullException(nameof(playerModel));

            _playerModel = playerModel;

            var invulnerabilityBosts = interactiveObjects.Where(x => x.Type == InteractiveObjectEnum.InvulnerabilityBost);
            foreach (var invulnerabilityBost in invulnerabilityBosts)
            {
                    invulnerabilityBost.OnInteraction += InvulnerabilityBostOnInteraction;
            }
        }

        #endregion


        #region Methods

        private void InvulnerabilityBostOnInteraction(InteractiveObject interactiveObject)
        {
            var invulnerabilityBost = interactiveObject as InvulnerabilityBost;
            _playerModel.SetInvulnerability();
            _effectDuration = invulnerabilityBost.EffectDuration;
        }

        private void ResetInvulnerability(float deltaTime)
        {
            if (_effectDuration <= 0)
            {
                if (_playerModel.IsInvulnerability)
                {
                    _playerModel.ResetInvulnerability();
                }
            }
            else
            {
                _effectDuration -= deltaTime;
            }
        }

        #endregion


        #region IUpdatable

        public void Update(float deltaTime)
        {
            ResetInvulnerability(deltaTime);
        }

        #endregion

    }
}
